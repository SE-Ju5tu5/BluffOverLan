<!DOCTYPE html>
<html>
<head>
    <title>Bluff Kartenspiel</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0f3460, #16537e);
            color: white;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .status {
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin: 10px;
            font-weight: bold;
        }
        .status.connected { background: rgba(46, 204, 113, 0.3); }
        .status.disconnected { background: rgba(231, 76, 60, 0.3); }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed;
            transform: none;
        }
        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #d68910); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-bluff {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            font-size: 20px;
            padding: 20px 40px;
            animation: pulse 2s infinite;
            border: 3px solid #fff;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .game-table {
            position: relative;
            width: 800px;
            height: 500px;
            margin: 20px auto;
            background: radial-gradient(ellipse, #2d5a27, #1a3317);
            border-radius: 50%;
            border: 8px solid #8B4513;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        .table-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 15px;
            min-width: 200px;
        }

        .player-seat {
            position: absolute;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            min-width: 120px;
            backdrop-filter: blur(5px);
        }

        .player-seat.current-turn {
            border: 3px solid #f39c12;
            background: rgba(243, 156, 18, 0.2);
            animation: glow 1.5s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px #f39c12; }
            to { box-shadow: 0 0 20px #f39c12; }
        }

        .seat-bottom { bottom: -60px; left: 50%; transform: translateX(-50%); }
        .seat-top { top: -60px; left: 50%; transform: translateX(-50%); }
        .seat-left { left: -80px; top: 50%; transform: translateY(-50%); }
        .seat-right { right: -80px; top: 50%; transform: translateY(-50%); }
        .seat-bottom-left { bottom: -40px; left: 100px; }
        .seat-bottom-right { bottom: -40px; right: 100px; }

        .my-hand {
            margin: 30px auto;
            max-width: 800px;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .card {
            width: 60px;
            height: 85px;
            border-radius: 8px;
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            border: 2px solid #34495e;
            margin: 3px;
            transition: all 0.3s ease;
            user-select: none;
            font-size: 12px;
        }
        .card:hover { transform: translateY(-10px); }
        .card.selected {
            border-color: #f39c12;
            transform: translateY(-15px);
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.7);
        }
        .card.hearts, .card.diamonds {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }
        .card.clubs, .card.spades {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
        }

        .game-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            max-width: 300px;
        }

        .message {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            text-align: center;
        }
        .message.success { background: rgba(46, 204, 113, 0.3); border: 1px solid #2ecc71; }
        .message.error { background: rgba(231, 76, 60, 0.3); border: 1px solid #e74c3c; }
        .message.info { background: rgba(52, 152, 219, 0.3); border: 1px solid #3498db; }
        .message.bluff-result { 
            background: rgba(255, 215, 0, 0.3); 
            border: 2px solid #FFD700;
            font-size: 16px;
            font-weight: bold;
            white-space: pre-line;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .game-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
        }

        .player-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            text-align: center;
        }

        input, select {
            padding: 10px;
            border: none;
            border-radius: 5px;
            margin: 5px;
            color: #2c3e50;
        }

        .selection-info {
            background: rgba(241, 196, 15, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #f1c40f;
        }

        .bluff-controls {
            text-align: center;
            margin: 20px 0;
        }

        .debug-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            z-index: 9999;
            font-size: 12px;
        }
        .debug-btn {
            font-size: 10px;
            padding: 3px 6px;
            margin: 2px;
        }

        @media (max-width: 900px) {
            .game-table {
                width: 600px;
                height: 400px;
            }
            .game-controls {
                position: relative;
                margin: 20px auto;
                max-width: 100%;
            }
            .my-hand {
                margin: 20px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1>Bluff Kartenspiel</h1>
            <div id="status" class="status disconnected">Verbinde...</div>
            <div id="playerInfo"></div>
        </div>

        <div class="debug-panel">
            <button onclick="debugGameState()" class="btn debug-btn">Debug</button>
            <button onclick="console.log('Hand:', playerHand)" class="btn debug-btn">Hand</button>
        </div>

        <div id="menuScreen" class="screen active">
            <div style="text-align: center;">
                <h2>Willkommen beim Bluff-Spiel!</h2>
                <p>Lege Karten verdeckt ab und behaupte was du willst - andere können dich anzweifeln!</p>
                
                <div style="margin: 20px 0;">
                    <input type="text" id="playerName" placeholder="Dein Name" maxlength="20">
                    <button class="btn" onclick="changeName()">Name ändern</button>
                </div>
                
                <button class="btn btn-success" onclick="createGame()">Neues Spiel erstellen</button>
                
                <div id="gamesList">
                    <div class="message info">Lade Spiele...</div>
                </div>
            </div>
        </div>

        <div id="lobbyScreen" class="screen">
            <div style="text-align: center;">
                <h2 id="gameTitle">Lobby</h2>
                <h3>Spieler:</h3>
                <div id="playersInLobby"></div>
                <div id="lobbyMessages"></div>
                <button id="readyBtn" class="btn btn-warning" onclick="toggleReady()" data-ready="false">Bereit</button>
                <button class="btn btn-danger" onclick="leaveGame()">Spiel verlassen</button>
            </div>
        </div>

        <div id="gameScreen" class="screen">
            <div id="gameMessages"></div>
            
            <div class="game-table">
                <div class="table-center">
                    <div id="lastClaim" style="display: none;">
                        <h4>Letzte Behauptung:</h4>
                        <p id="lastClaimText"></p>
                    </div>
                    <div id="centerPileInfo">
                        <p>Karten in der Mitte: <span id="centerPileCount">0</span></p>
                    </div>
                </div>
                <div id="tableSeats"></div>
            </div>

            <div class="game-controls">
                <div id="bluffControls" class="bluff-controls" style="display: none;">
                    <button class="btn btn-bluff" onclick="callBluff()">BLUFF!</button>
                    <p>Zweifel die Behauptung an!</p>
                </div>
                
                <div id="playControls" style="display: none;">
                    <h3>Du bist am Zug!</h3>
                    
                    <div id="selectionInfo" class="selection-info" style="display: none;">
                        <span id="selectedCount">0</span> Karte(n) ausgewählt
                    </div>
                    
                    <div>
                        <label>Wert behaupten:</label>
                        <select id="claimValue">
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">J</option>
                            <option value="12">Q</option>
                            <option value="13">K</option>
                            <option value="14">A</option>
                        </select>
                        
                        <button class="btn btn-success" onclick="playSelectedCards()" id="playCardsBtn" disabled>
                            Karten spielen
                        </button>
                    </div>
                </div>
                
                <button class="btn btn-danger" onclick="leaveGame()">Spiel verlassen</button>
            </div>

            <div class="my-hand">
                <div style="margin-bottom: 15px;">
                    <h3>Deine Karten (<span id="handCount">0</span>)</h3>
                </div>
                <div id="playerHand"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        var currentGameId = null;
        var playerData = null;
        var gameData = null;
        var playerHand = [];
        var selectedCards = [];

        console.log('JavaScript wird geladen...');

        function updateStatus(type, text) {
            var status = document.getElementById('status');
            status.className = 'status ' + type;
            status.textContent = text;
        }

        function showScreen(screenId) {
            var screens = document.querySelectorAll('.screen');
            for (var i = 0; i < screens.length; i++) {
                screens[i].classList.remove('active');
            }
            document.getElementById(screenId).classList.add('active');
        }

        function showMessage(type, text, containerId) {
            containerId = containerId || 'gameMessages';
            var container = document.getElementById(containerId);
            if (!container) return;
            
            var message = document.createElement('div');
            message.className = 'message ' + type;
            message.textContent = text;
            container.appendChild(message);
            
            setTimeout(function() {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, type === 'bluff-result' ? 10000 : 5000);
        }

        function debugGameState() {
            console.log('=== GAME STATE DEBUG ===');
            console.log('playerData:', playerData);
            console.log('gameData:', gameData);
            console.log('selectedCards:', selectedCards);
            console.log('playerHand:', playerHand);
            console.log('========================');
        }

        function updateGamesList(games) {
            var container = document.getElementById('gamesList');
            if (!container) return;
            
            container.innerHTML = '';

            if (!games || games.length === 0) {
                container.innerHTML = '<div class="message info">Keine Spiele verfügbar</div>';
                return;
            }

            for (var i = 0; i < games.length; i++) {
                var game = games[i];
                if (!game) continue;
                
                var gameElement = document.createElement('div');
                gameElement.className = 'game-card';
                gameElement.onclick = (function(gameId) {
                    return function() { joinGame(gameId); };
                })(game.id);
                
                var host = game.host || 'Unbekannt';
                var playerCount = game.playerCount || 0;
                var gameState = game.gameState || 'waiting';
                var gameStateText = getGameStateText(gameState);
                
                gameElement.innerHTML = 
                    '<h3>Spiel von ' + host + '</h3>' +
                    '<p>Spieler: ' + playerCount + '/6</p>' +
                    '<p>Status: ' + gameStateText + '</p>';
                
                container.appendChild(gameElement);
            }
        }

        function createGame() {
            console.log('createGame aufgerufen');
            socket.emit('createGame', {});
        }

        function joinGame(gameId) {
            console.log('joinGame aufgerufen:', gameId);
            socket.emit('joinGame', { gameId: gameId });
            showScreen('lobbyScreen');
        }

        function leaveGame() {
            console.log('leaveGame aufgerufen');
            socket.emit('leaveGame', {});
            currentGameId = null;
            gameData = null;
            playerHand = [];
            selectedCards = [];
            var readyBtn = document.getElementById('readyBtn');
            readyBtn.dataset.ready = 'false';
            readyBtn.textContent = 'Bereit';
            readyBtn.className = 'btn btn-warning';
            showScreen('menuScreen');
            refreshGames();
        }

        function toggleReady() {
            var readyBtn = document.getElementById('readyBtn');
            var isReady = readyBtn.dataset.ready === 'true';
            
            readyBtn.dataset.ready = (!isReady).toString();
            
            if (!isReady) {
                readyBtn.textContent = 'Bereit ✓';
                readyBtn.className = 'btn btn-success';
            } else {
                readyBtn.textContent = 'Bereit';
                readyBtn.className = 'btn btn-warning';
            }
            
            socket.emit('playerReady');
        }

        function refreshGames() {
            socket.emit('refreshGames');
        }

        function changeName() {
            var nameInput = document.getElementById('playerName');
            var newName = nameInput.value.trim();
            if (newName && playerData) {
                playerData.name = newName;
                socket.emit('changeName', { name: newName });
                document.getElementById('playerInfo').innerHTML = 
                    '<div class="status connected">Spieler: ' + playerData.name + '</div>';
            }
        }

        function toggleCardSelection(cardId) {
            console.log('Karte auswählen:', cardId);
            var index = selectedCards.indexOf(cardId);
            if (index === -1) {
                selectedCards.push(cardId);
                console.log('Karte hinzugefügt:', cardId);
            } else {
                selectedCards.splice(index, 1);
                console.log('Karte entfernt:', cardId);
            }
            
            console.log('Aktuelle Auswahl:', selectedCards);
            updateCardSelection();
            updatePlayButton();
        }

        function updateCardSelection() {
            var cards = document.querySelectorAll('.card');
            console.log('Alle Karten:', cards.length);
            
            for (var i = 0; i < cards.length; i++) {
                var cardEl = cards[i];
                var cardId = cardEl.getAttribute('data-card-id');
                if (selectedCards.indexOf(cardId) !== -1) {
                    cardEl.classList.add('selected');
                } else {
                    cardEl.classList.remove('selected');
                }
            }

            if (gameData && gameData.lastClaim) {
                updateCardValueSelection(); // Zeigt die neuen Regeln
            } else {
                // Normale Auswahl für ersten Spieler
                var selectionInfo = document.getElementById('selectionInfo');
                
                if (selectedCards.length > 0) {
                    selectionInfo.innerHTML = selectedCards.length + ' Karte(n) ausgewählt';
                    selectionInfo.style.display = 'block';
                } else {
                    selectionInfo.style.display = 'none';
                }
            }
        }

        function updateCardValueSelection() {
            var claimValueSelect = document.getElementById('claimValue');
            if (!claimValueSelect) return;
            
            if (gameData.lastClaim) {
                var valueMap = {
                    '2': '2', '3': '3', '4': '4', '5': '5', '6': '6', '7': '7', '8': '8', '9': '9', '10': '10',
                    'J': '11', 'Q': '12', 'K': '13'
                };
                
                var requiredValue = valueMap[gameData.lastClaim.value] || gameData.lastClaim.value;
                claimValueSelect.value = requiredValue;
                claimValueSelect.disabled = true;
                
                var selectionInfo = document.getElementById('selectionInfo');
                var newTotal = gameData.lastClaim.count + selectedCards.length;
                
                var infoText = '<strong>Du musst ' + gameData.lastClaim.value + ' behaupten!</strong><br>' +
                              'Aktuelle Behauptung: ' + gameData.lastClaim.count + 'x ' + gameData.lastClaim.value + '<br>' +
                              'Deine Karten: ' + selectedCards.length + ' → Neue Gesamtanzahl: ' + newTotal + 'x ' + gameData.lastClaim.value + '<br>' +
                              '(Mindestens 1 Karte erforderlich)';
                              
                selectionInfo.innerHTML = infoText;
                selectionInfo.style.display = 'block';
            } else {
                claimValueSelect.disabled = false;
            }
        }

        function updatePlayButton() {
            var playBtn = document.getElementById('playCardsBtn');
            if (!playBtn) return;
            
            var canPlay = false;
            var buttonText = 'Karten wählen';
            
            if (selectedCards.length > 0 && gameData && gameData.isCurrentPlayer === true) {
                if (gameData.lastClaim) {
                    canPlay = selectedCards.length >= 1;
                    if (canPlay) {
                        var newTotal = gameData.lastClaim.count + selectedCards.length;
                        buttonText = selectedCards.length + ' hinzufügen → ' + newTotal + 'x ' + gameData.lastClaim.value;
                    } else {
                        buttonText = 'Mindestens 1 Karte erforderlich';
                    }
                } else {
                    canPlay = true;
                    buttonText = selectedCards.length + ' Karte(n) spielen';
                }
            }
            
            playBtn.disabled = !canPlay;
            playBtn.textContent = buttonText;
            
            if (canPlay) {
                playBtn.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
            } else {
                playBtn.style.background = 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
            }
        }

        function playSelectedCards() {
            if (selectedCards.length === 0) {
                showMessage('error', 'Bitte wähle zuerst Karten aus');
                return;
            }
            
            if (gameData.lastClaim && selectedCards.length < 1) {
                showMessage('error', 'Du musst mindestens 1 Karte spielen');
                return;
            }
            
            var claimValueNum = parseInt(document.getElementById('claimValue').value);
            var claimCount = selectedCards.length;

            var valueMap = {
                2: { name: '2', value: 2 },
                3: { name: '3', value: 3 },
                4: { name: '4', value: 4 },
                5: { name: '5', value: 5 },
                6: { name: '6', value: 6 },
                7: { name: '7', value: 7 },
                8: { name: '8', value: 8 },
                9: { name: '9', value: 9 },
                10: { name: '10', value: 10 },
                11: { name: 'J', value: 11 },
                12: { name: 'Q', value: 12 },
                13: { name: 'K', value: 13 }
            };

            var claimedValue = valueMap[claimValueNum];

            console.log('Spiele Karten:', {
                cardIds: selectedCards,
                claimedCount: claimCount,
                claimedValue: claimedValue
            });

            socket.emit('playCards', {
                cardIds: selectedCards,
                claimedCount: claimCount,
                claimedValue: claimedValue
            });

            selectedCards = [];
            updateCardSelection();
            updatePlayButton();
        }

        function callBluff() {
            console.log('Rufe Bluff!');
            socket.emit('callBluff');
        }

        function updateLobby() {
            if (!gameData) return;

            document.getElementById('gameTitle').textContent = 
                'Bluff-Spiel (' + gameData.players.length + '/6 Spieler)';

            var playersContainer = document.getElementById('playersInLobby');
            playersContainer.innerHTML = '';

            for (var i = 0; i < gameData.players.length; i++) {
                var player = gameData.players[i];
                var playerElement = document.createElement('div');
                playerElement.className = 'player-card';
                
                playerElement.innerHTML = 
                    '<h4>' + player.name + '</h4>' +
                    '<p id="ready-' + player.id + '">Warten...</p>';
                
                playersContainer.appendChild(playerElement);
            }
        }

        function updateTableSeats() {
            if (!gameData || !playerData) return;

            var seatsContainer = document.getElementById('tableSeats');
            seatsContainer.innerHTML = '';

            var seatPositions = ['seat-top', 'seat-right', 'seat-bottom-right', 'seat-bottom-left', 'seat-left'];
            var otherPlayers = gameData.players.filter(function(p) { return p.id !== playerData.id; });

            for (var i = 0; i < otherPlayers.length; i++) {
                var player = otherPlayers[i];
                var seatElement = document.createElement('div');
                var positionClass = seatPositions[i % seatPositions.length];
                
                var isCurrentTurn = gameData.currentPlayer === player.name;
                seatElement.className = 'player-seat ' + positionClass + (isCurrentTurn ? ' current-turn' : '');
                
                seatElement.innerHTML = 
                    '<h4>' + player.name + '</h4>' +
                    '<p>' + player.cardCount + ' Karten</p>' +
                    (isCurrentTurn ? '<p><strong>Am Zug</strong></p>' : '');
                
                seatsContainer.appendChild(seatElement);
            }
        }

        function updateGame() {
            if (!gameData) return;

            console.log('Update Game called:', gameData);

            document.getElementById('centerPileCount').textContent = gameData.centerPileCount;

            var lastClaimEl = document.getElementById('lastClaim');
            var lastClaimText = document.getElementById('lastClaimText');
            
            if (gameData.lastClaim) {
                lastClaimText.textContent = gameData.lastClaim.player + ' behauptet: ' + 
                    gameData.lastClaim.count + ' x ' + gameData.lastClaim.value;
                lastClaimEl.style.display = 'block';
            } else {
                lastClaimEl.style.display = 'none';
            }

            updateTableSeats();

            var playControls = document.getElementById('playControls');
            var bluffControls = document.getElementById('bluffControls');
            
            if (gameData.isCurrentPlayer) {
                console.log('Spieler ist am Zug');
                playControls.style.display = 'block';
                
                if (gameData.canCallBluff && gameData.lastClaim) {
                    bluffControls.style.display = 'block';
                } else {
                    bluffControls.style.display = 'none';
                }
                
                updateCardValueSelection();
                updatePlayButton();
            } else {
                playControls.style.display = 'none';
                bluffControls.style.display = 'none';
            }
        }

        function updatePlayerHand() {
            console.log('=== UPDATE PLAYER HAND ===');
            console.log('playerHand:', playerHand);
            
            var handContainer = document.getElementById('playerHand');
            var handCount = document.getElementById('handCount');
            
            if (!handContainer) {
                console.log('Hand Container nicht gefunden');
                return;
            }
            
            handContainer.innerHTML = '';
            
            handCount.textContent = playerHand ? playerHand.length : 0;
            
            if (!playerHand || playerHand.length === 0) {
                console.log('Keine Karten in der Hand');
                handContainer.innerHTML = '<p style="color: #888;">Keine Karten vorhanden</p>';
                return;
            }
            
            console.log('Erstelle', playerHand.length, 'Karten');

            for (var i = 0; i < playerHand.length; i++) {
                var card = playerHand[i];
                console.log('Erstelle Karte:', card);
                
                var cardElement = document.createElement('div');
                cardElement.className = 'card ' + card.suit;
                cardElement.setAttribute('data-card-id', card.id);
                cardElement.onclick = (function(cardId) {
                    return function() { 
                        toggleCardSelection(cardId); 
                    };
                })(card.id);
                
                cardElement.innerHTML = 
                    '<div style="font-size: 14px; font-weight: bold;">' + card.value + '</div>' +
                    '<div style="font-size: 16px; margin-top: 5px;">' + getSuitSymbol(card.suit) + '</div>';
                
                handContainer.appendChild(cardElement);
            }
            
            console.log('Karten erstellt, rufe updateCardSelection auf');
            updateCardSelection();
            console.log('=== UPDATE PLAYER HAND ENDE ===');
        }

        function getSuitSymbol(suit) {
            var symbols = {
                hearts: '♥',
                diamonds: '♦',
                clubs: '♣',
                spades: '♠'
            };
            return symbols[suit] || suit;
        }

        function getGameState() {
            if (state === 'waiting') {
                return 'Wartet auf Spieler';
            } else if (state === 'playing') {
                return 'Spiel läuft';
            } else if (state === 'finished') {
                return 'Beendet';
            } else {
                return state;
            }
        }

        socket.on('connect', function() {
            updateStatus('connected', 'Verbunden');
        });

        socket.on('disconnect', function() {
            updateStatus('dsconnected', 'Getrennt');
        });

        socket.on('playerConnected', function(data) {
            playerData = data.player;
            document.getElementById('playerInfo').innerHTML = 
                '<div class="status connected">Spieler: ' + playerData.name + '</div>';
            document.getElementById('playerName').value = playerData.name;
        });

        socket.on('gamesList', function(games) {
            console.log('Received games list:', games);
            updateGamesList(games);
        });

        socket.on('gameCreated', function(data) {
            currentGameId = data.gameId;
            gameData = data.gameState;
            showScreen('lobbyScreen');
            updateLobby();
        });

        socket.on('gameUpdate', function(data) {
            gameData = data;
            if (gameData.gameState === 'waiting') {
                updateLobby();
            } else if (gameData.gameState === 'playing') {
                updateGame();
            }
        });

        socket.on('lobbyUpdate', function(data) {
            console.log('Received lobbyUpdate:', data);
            
            for (var i = 0; i < data.players.length; i++) {
                var player = data.players[i];
                var readyElement = document.getElementById('ready-' + player.id);
                if (readyElement) {
                    if (player.ready) {
                        readyElement.textContent = 'Bereit ✓';
                        readyElement.style.color = '#2ecc71';
                  } else {
                        readyElement.textContent = 'Warten...';
                        readyElement.style.color = '#f39c12';
                    }
                }
            }
            
            if (data.allReady && data.players.length >= 2) {
                showMessage('success', 'Alle Spieler bereit! Spiel startet...', 'lobbyMessages');
            }
        });

        socket.on('gameStarted', function(data) {
            console.log('Spiel gestartet!', data);
            gameData = data;
            showScreen('gameScreen');
            updateGame();
            showMessage('success', 'Spiel gestartet! Viel Spaß!');
        });

        socket.on('playerGameState', function(data) {
            console.log('Received playerGameState:', data);
            gameData = data;
            playerHand = data.playerHand || [];
            console.log('Neue playerHand:', playerHand);
            updateGame();
            updatePlayerHand();
        });

        socket.on('bluffResult', function(data) {
            console.log('Bluff Result:', data);
            var cardList = data.actualCards.map(function(c) { 
                return c.value + c.suit; 
            }).join(', ');
            var message = data.message + '\n\nGespielte Karten: ' + cardList;
            showMessage('bluff-result', message);
        });

        socket.on('quadsRemoved', function(data) {
            console.log('Quads removed:', data);
            showMessage('success', data.player + ' hatte 4x ' + data.value + ' - diese wurden entfernt!');
        });

        socket.on('playerLostAces', function(data) {
            console.log('Player lost with aces:', data);
            showMessage('error', data.player + ' hat 4 Asse und verliert das Spiel!');
        });

        socket.on('nameChanged', function(data) {
            if (playerData) {
                playerData.name = data.name;
                document.getElementById('playerInfo').innerHTML = 
                    '<div class="status connected">Spieler: ' + playerData.name + '</div>';
            }
        });

        socket.on('error', function(data) {
            console.error('Server error:', data);
            showMessage('error', data.message);
        });

        setTimeout(function() {
            refreshGames();
        }, 1000);

        console.log('JavaScript vollständig geladen!');
    </script>
</body>
</html>
